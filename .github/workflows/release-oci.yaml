name: release-oci

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  oci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Set up ORAS
        run: |
          curl -sSL https://github.com/oras-project/oras/releases/download/v1.1.0/oras_1.1.0_linux_amd64.tar.gz | tar xz
          sudo mv oras /usr/local/bin/

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean --skip=validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build OCI artifact layout
        run: |
          mkdir -p oci/bin/linux/amd64
          mkdir -p oci/bin/linux/arm64
          mkdir -p oci/bin/darwin/amd64
          mkdir -p oci/bin/darwin/arm64
          
          # Extract entrypoint binaries from GoReleaser release archives
          tar -xzf dist/liteci_*_linux_amd64.tar.gz -C oci/bin/linux/amd64/
          tar -xzf dist/liteci_*_linux_arm64.tar.gz -C oci/bin/linux/arm64/
          tar -xzf dist/liteci_*_darwin_amd64.tar.gz -C oci/bin/darwin/amd64/
          tar -xzf dist/liteci_*_darwin_arm64.tar.gz -C oci/bin/darwin/arm64/
          
          # Copy provider resources
          cp thin.provider.yaml oci/
          cp -r assets oci/
          
          # Fix permissions
          chmod +x oci/bin/*/*/entrypoint

      - name: Push provider manifest layer
        run: |
          oras push ghcr.io/${{ github.repository }}:${{ github.ref_name }} \
            --artifact-type application/vnd.thin.provider.v1 \
            oci/thin.provider.yaml:application/yaml

      - name: Push assets layer
        run: |
          oras push ghcr.io/${{ github.repository }}:${{ github.ref_name }} \
            oci/assets/:application/vnd.sourceplane.assets.v1

      - name: Push linux-amd64 binary layer
        run: |
          oras push ghcr.io/${{ github.repository }}:${{ github.ref_name }} \
            oci/bin/linux/amd64/entrypoint:application/vnd.sourceplane.bin.linux-amd64

      - name: Push linux-arm64 binary layer
        run: |
          oras push ghcr.io/${{ github.repository }}:${{ github.ref_name }} \
            oci/bin/linux/arm64/entrypoint:application/vnd.sourceplane.bin.linux-arm64

      - name: Push darwin-amd64 binary layer
        run: |
          oras push ghcr.io/${{ github.repository }}:${{ github.ref_name }} \
            oci/bin/darwin/amd64/entrypoint:application/vnd.sourceplane.bin.darwin-amd64

      - name: Push darwin-arm64 binary layer
        run: |
          oras push ghcr.io/${{ github.repository }}:${{ github.ref_name }} \
            oci/bin/darwin/arm64/entrypoint:application/vnd.sourceplane.bin.darwin-arm64

      - name: Push examples layer (optional)
        if: success() && hashFiles('examples/') != ''
        run: |
          oras push ghcr.io/${{ github.repository }}:${{ github.ref_name }} \
            --artifact-type application/vnd.thin.provider.v1 \
            examples/:application/vnd.sourceplane.examples.v1

      - name: Verify OCI artifact
        run: |
          echo "âœ… OCI artifact published at ghcr.io/${{ github.repository }}:${{ github.ref_name }}"
          echo "Available layers in manifest:"
          echo "  - core: provider config, schemas, assets"
          echo "  - binaries: linux-amd64, linux-arm64, darwin-amd64, darwin-arm64"
          echo "  - examples: (optional)"
