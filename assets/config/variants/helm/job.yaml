apiVersion: sourceplane.io/v1
kind: JobRegistry
metadata:
  name: helm-jobs
  description: Helm deployment jobs
jobs:
  - name: deploy
    description: Deploy using Helm
    timeout: 15m
    retries: 2
    labels:
      scope: deployment
    steps:
      - name: add-repository
        run: helm repo add mycompany oci://mycompany.azurecr.io/helm/charts
        retry: 3
      - name: update-repo
        run: helm repo update
        retry: 2
      - name: deploy
        run: helm upgrade --install {{.Component}} {{.chart}} --namespace {{.namespacePrefix}}{{.Component}} --create-namespace --wait=true --timeout={{.timeout}}
        timeout: 15m
        onFailure: stop
      - name: verify
        run: kubectl get deployment -n {{.namespacePrefix}}{{.Component}} {{.Component}}
        onFailure: continue
    inputs:
      pullPolicy: IfNotPresent
      imagePullSecrets: []

  - name: rollback
    description: Rollback Helm release to previous version
    timeout: 10m
    retries: 1
    labels:
      scope: recovery
    steps:
      - name: get-revision
        run: helm history {{.Component}} -n {{.namespacePrefix}}{{.Component}} | head -2
        onFailure: stop
      - name: rollback
        run: helm rollback {{.Component}} -n {{.namespacePrefix}}{{.Component}}
        timeout: 10m
        onFailure: stop
      - name: verify-rollback
        run: kubectl rollout status deployment/{{.Component}} -n {{.namespacePrefix}}{{.Component}}
        onFailure: continue
    inputs:
      pullPolicy: IfNotPresent

  - name: diff
    description: Show differences between deployed and intended Helm release
    timeout: 5m
    retries: 0
    labels:
      scope: analysis
    steps:
      - name: add-repository
        run: helm repo add mycompany oci://mycompany.azurecr.io/helm/charts
        retry: 3
      - name: diff
        run: helm diff release {{.Component}} {{.chart}} --namespace {{.namespacePrefix}}{{.Component}} || true
        onFailure: continue
    inputs:
      pullPolicy: IfNotPresent
