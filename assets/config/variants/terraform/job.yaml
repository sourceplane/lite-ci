apiVersion: sourceplane.io/v1
kind: JobRegistry
metadata:
  name: terraform-jobs
  description: Terraform infrastructure jobs
jobs:
  - name: plan
    description: Plan Terraform configuration
    timeout: 20m
    retries: 1
    labels:
      scope: analysis
    steps:
      - name: init
        run: terraform init -backend=true
        onFailure: stop
      - name: fmt-check
        run: terraform fmt -check
        onFailure: continue
      - name: validate
        run: terraform validate
        timeout: 5m
        onFailure: stop
      - name: plan
        run: terraform plan -workspace={{.workspace}} -out=tfplan
        timeout: 15m
        onFailure: stop
    inputs:
      autoApprove: "false"
      parallelism: 10

  - name: apply
    description: Apply Terraform configuration
    timeout: 30m
    retries: 1
    labels:
      scope: deployment
    steps:
      - name: init
        run: terraform init -backend=true
        onFailure: stop
      - name: validate
        run: terraform validate
        timeout: 5m
        onFailure: stop
      - name: plan
        run: terraform plan -workspace={{.workspace}} -out=tfplan
        timeout: 15m
        onFailure: stop
      - name: apply
        run: terraform apply -auto-approve tfplan
        timeout: 20m
        onFailure: stop
      - name: output
        run: terraform output -json > outputs.json
        onFailure: continue
    inputs:
      autoApprove: "false"
      parallelism: 10

  - name: destroy
    description: Destroy Terraform managed infrastructure
    timeout: 25m
    retries: 0
    labels:
      scope: cleanup
    steps:
      - name: init
        run: terraform init -backend=true
        onFailure: stop
      - name: destroy
        run: terraform destroy -workspace={{.workspace}} -auto-approve
        timeout: 20m
        onFailure: stop
      - name: workspace-delete
        run: terraform workspace delete {{.workspace}}
        onFailure: continue
    inputs:
      autoApprove: "false"
      parallelism: 10
